<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recipe Search</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <style>
      .recipe-card {
        transition: transform 0.2s;
        cursor: pointer;
      }

      .recipe-card:hover {
        transform: scale(1.02);
      }

      .recipe-image {
          height: 200px;
          object-fit: cover;
          background: url('/static/loading.gif') center no-repeat;
          background-color: #f8f9fa;
      }

      .select2-container {
        width: 100% !important;
      }

      .diet-filters {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
      }

      .diet-filter-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .diet-filter-checkbox input[type="checkbox"] {
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
      }

      .diet-filter-checkbox label {
        cursor: pointer;
        margin-bottom: 0;
        font-weight: 500;
      }

      .keto-label {
        color: #dc3545;
      }

      .vegan-label {
        color: #198754;
      }
    </style>
  </head>

  <body>
    <div class="container py-5">
      <h1 class="text-center mb-4">Recipe Search</h1>

      <!-- Search Bar -->
      <div class="row justify-content-center mb-4">
        <div class="col-md-8">
          <select
            class="form-select"
            id="ingredientSearch"
            multiple="multiple"
          ></select>

          <!-- Diet Filters -->
          <div class="diet-filters">
            <div class="diet-filter-checkbox">
              <input type="checkbox" id="ketoFilter" value="keto" />
              <label for="ketoFilter" class="keto-label">
                <span class="badge bg-danger">Keto</span> Only
              </label>
            </div>
            <div class="diet-filter-checkbox">
              <input type="checkbox" id="veganFilter" value="vegan" />
              <label for="veganFilter" class="vegan-label">
                <span class="badge bg-success">Vegan</span> Only
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Container -->
      <div class="row" id="resultsContainer"></div>
    </div>

    <!-- Recipe Modal -->
    <div class="modal fade" id="recipeModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle"></h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4">
                <img id="modalImage" class="img-fluid rounded" src="" alt="" />
              </div>
              <div class="col-md-8">
                <h6>Description</h6>
                <p id="modalDescription"></p>

                <h6>Ingredients</h6>
                <ul id="modalIngredients"></ul>

                <h6>Instructions</h6>
                <ol id="modalInstructions"></ol>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-light">
      <div class="container text-center">
        <p class="text-muted mb-0">
          <small>
            This data was collected from publicly available recipes from
            allrecipes.com for educational purposes only.
          </small>
        </p>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      const searchCache = new Map();

      $(document).ready(function () {
        // Initialize Select2
        $("#ingredientSearch").select2({
          theme: "bootstrap-5",
          placeholder: "Search for ingredients...",
          allowClear: true,
          ajax: {
            url: "/select2",
            dataType: "json",
            delay: 250,
            data: function (params) {
              return {
                q: params.term,
              };
            },
            processResults: function (data) {
              return data;
            },
            cache: true,
          },
        });

        // Handle search on ingredient selection
        $("#ingredientSearch").on("change", function () {
          performSearch();
        });

        // Handle diet filter changes
        $(document).on("change", "#ketoFilter, #veganFilter", function () {
          performSearch();
        });

        // Initialize modal
        const recipeModal = new bootstrap.Modal(
          document.getElementById("recipeModal")
        );
      });

    function performSearch() {
        const selectedIngredients = $("#ingredientSearch").val();
        const ketoOnly = $("#ketoFilter").is(":checked");
        const veganOnly = $("#veganFilter").is(":checked");

        // Perform search if either ingredients are selected OR diet filters are active
        if (
            (selectedIngredients && selectedIngredients.length > 0) ||
            ketoOnly ||
            veganOnly
        ) {
            searchRecipes(selectedIngredients || []);
        } else {
            $("#resultsContainer").empty();
        }
    }


    function searchRecipes(ingredients) {
        // FIX: Extract actual ingredient names from Select2 values
        // Select2 returns the actual ingredient names as values since we set "id": ingredient name
        const query = Array.isArray(ingredients) ? ingredients.join(" ") : "";
        const ketoOnly = $("#ketoFilter").is(":checked");
        const veganOnly = $("#veganFilter").is(":checked");

        // Create proper cache key with actual ingredient names
        const cacheKey = `${query}|${ketoOnly}|${veganOnly}`;
        
        // DEBUG: Log cache operations
        console.log("Cache key:", cacheKey);
        console.log("Cache has key:", searchCache.has(cacheKey));
        console.log("Current cache size:", searchCache.size);

        // Check cache first
        if (searchCache.has(cacheKey)) {
            console.log("Using cached results");
            displayResults(searchCache.get(cacheKey));
            return;
        }

        console.log("Making new API request");

        // Build query parameters
        const params = {};
        if (query) params.q = query;
        if (ketoOnly) params.keto = "true";
        if (veganOnly) params.vegan = "true";

        $.get("/search", params)
            .done(function (data) {
                console.log("Caching results for key:", cacheKey);
                // Cache the results
                searchCache.set(cacheKey, data.results);
                // Limit cache size (LRU eviction)
                if (searchCache.size > 50) {
                    const firstKey = searchCache.keys().next().value;
                    searchCache.delete(firstKey);
                    console.log("Evicted oldest cache entry:", firstKey);
                }
                displayResults(data.results);
            })
            .fail(function (error) {
                console.error("Search failed:", error);
            });
    }
      // Update the displayResults function
      function displayResults(results) {
          const container = $("#resultsContainer");
          container.empty();

          results.forEach((recipe) => {
              const card = `
                  <div class="col-md-4 mb-4">
                      <div class="card recipe-card" onclick="showRecipeDetails(${JSON.stringify(recipe).replace(/"/g, "&quot;")})">
                          <img src="${recipe.photo_url || '/static/loading-image-failed.svg'}" 
                              class="card-img-top recipe-image" 
                              alt="${recipe.title}"
                              loading="lazy"
                              onerror="this.onerror=null; this.src='/static/loading-image-failed.svg';">
                          <div class="card-body">
                              <h5 class="card-title d-flex justify-content-between align-items-center">
                                  ${recipe.title}
                                  <div>
                                      ${recipe.keto ? '<span class="badge bg-danger">Keto</span>' : ""}
                                      ${recipe.vegan ? '<span class="badge bg-success">Vegan</span>' : ""}
                                  </div>
                              </h5>
                          </div>
                      </div>
                  </div>
              `;
              container.append(card);
          });

          if (results.length === 0) {
              container.append('<div class="col-12 text-center"><p class="text-muted">No recipes found matching your criteria.</p></div>');
          }
      }

      function showRecipeDetails(recipe) {
        $("#modalTitle").text(recipe.title);
        $("#modalImage").attr("src", recipe.photo_url || '/static/loading-image-failed.svg');
        $("#modalImage").attr("onerror", "this.onerror=null; this.src='/static/loading-image-failed.svg';");
        $("#modalDescription").text(recipe.description);

        // Clear and populate ingredients
        const ingredientsList = $("#modalIngredients");
        ingredientsList.empty();
        recipe.ingredients.forEach((ingredient) => {
          ingredientsList.append(`<li>${ingredient}</li>`);
        });

        // Clear and populate instructions
        const instructionsList = $("#modalInstructions");
        instructionsList.empty();
        recipe.instructions.forEach((instruction) => {
          instructionsList.append(`<li>${instruction}</li>`);
        });

        // Show modal
        const recipeModal = new bootstrap.Modal(
          document.getElementById("recipeModal")
        );
        recipeModal.show();
      }
    </script>
  </body>
</html>